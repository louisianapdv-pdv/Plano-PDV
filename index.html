<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Adega</title>
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="logo.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas externas -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { 
        getAuth, 
        GoogleAuthProvider, 
        signInWithPopup, 
        signOut,
        onAuthStateChanged 
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { 
        getFirestore,
        collection,
        doc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Configuração do Firebase - PROJETO CORRIGIDO
      const firebaseConfig = {
        apiKey: "AIzaSyBuob65d4nwic1hXTGSsLtc38dEoD1H0zU",
        authDomain: "pdv26-aa76b.firebaseapp.com",
        projectId: "pdv26-aa76b",
        storageBucket: "pdv26-aa76b.appspot.com",
        messagingSenderId: "885941177258",
        appId: "1:885941177258:web:98f2690e07ec0a087cf9d3"
      };

      // Inicializar Firebase
      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Lista de emails autorizados - ADICIONE SEUS EMAILS AQUI
        const authorizedEmails = [
          "pablohenriquerodriguesgracioli@gmail.com",
          "admin@adega.com",
          "vendedor@adega.com",
          "teste@adega.com" // Adicione mais emails conforme necessário
        ];

        // Exportar para uso global
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseProvider = provider;
        window.authorizedEmails = authorizedEmails;

        // Funções de autenticação
        window.signInWithGoogle = async () => {
          try {
            console.log("Iniciando login com Google...");
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            console.log("Usuário autenticado:", user.email);
            
            if (!authorizedEmails.includes(user.email)) {
              console.log("Email não autorizado:", user.email);
              await signOut(auth);
              throw new Error("Email não autorizado para acessar o sistema.");
            }
            
            console.log("Login bem-sucedido!");
            return user;
          } catch (error) {
            console.error("Erro no login:", error);
            throw error;
          }
        };

        window.signOutUser = () => {
          console.log("Deslogando usuário...");
          return signOut(auth);
        };
        
        window.getCurrentUser = () => {
          const user = auth.currentUser;
          if (user) {
            console.log("Usuário atual:", user.email);
          }
          return user;
        };

        // Monitorar estado de autenticação
        onAuthStateChanged(auth, (user) => {
          console.log("Estado de autenticação alterado:", user ? user.email : "Nenhum usuário");
          if (user && authorizedEmails.includes(user.email)) {
            window.currentUser = user;
            window.dispatchEvent(new CustomEvent('authStateChanged', { 
              detail: { user, loggedIn: true } 
            }));
          } else {
            window.currentUser = null;
            window.dispatchEvent(new CustomEvent('authStateChanged', { 
              detail: { user: null, loggedIn: false } 
            }));
          }
        });

        // Funções do Firestore
        window.dbOperations = {
          // Produtos
          async addProduct(product) {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            const productRef = doc(collection(db, "products"));
            await setDoc(productRef, {
              ...product,
              id: productRef.id,
              createdBy: user.uid,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            return productRef.id;
          },

          async updateProduct(id, product) {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            const productRef = doc(db, "products", id);
            await updateDoc(productRef, {
              ...product,
              updatedAt: serverTimestamp()
            });
          },

          async deleteProduct(id) {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            await deleteDoc(doc(db, "products", id));
          },

          async getProducts() {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            try {
              const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
              const querySnapshot = await getDocs(q);
              return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
              console.error("Erro ao buscar produtos:", error);
              return [];
            }
          },

          // Vendas
          async addSale(sale) {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            const saleRef = doc(collection(db, "sales"));
            await setDoc(saleRef, {
              ...sale,
              id: saleRef.id,
              userId: user.uid,
              userEmail: user.email,
              createdAt: serverTimestamp()
            });
            return saleRef.id;
          },

          async getSales() {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            try {
              const q = query(collection(db, "sales"), orderBy("createdAt", "desc"));
              const querySnapshot = await getDocs(q);
              return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
              console.error("Erro ao buscar vendas:", error);
              return [];
            }
          },

          async clearAllSales() {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            try {
              const sales = await this.getSales();
              const deletePromises = sales.map(sale => deleteDoc(doc(db, "sales", sale.id)));
              await Promise.all(deletePromises);
            } catch (error) {
              console.error("Erro ao limpar vendas:", error);
            }
          },

          // Carrinho
          async saveCart(cart) {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              throw new Error("Não autorizado");
            }
            
            const cartRef = doc(db, "carts", user.uid);
            await setDoc(cartRef, {
              items: cart,
              userId: user.uid,
              updatedAt: serverTimestamp()
            });
          },

          async getCart() {
            const user = auth.currentUser;
            if (!user || !authorizedEmails.includes(user.email)) {
              return [];
            }
            
            try {
              const cartRef = doc(db, "carts", user.uid);
              const docSnap = await getDoc(cartRef);
              return docSnap.exists() ? docSnap.data().items || [] : [];
            } catch (error) {
              console.error("Erro ao buscar carrinho:", error);
              return [];
            }
          }
        };

        console.log("Firebase inicializado com sucesso!");
        
        // Disparar evento que Firebase está pronto
        window.dispatchEvent(new Event('firebaseReady'));

      } catch (error) {
        console.error("Erro ao inicializar Firebase:", error);
        // Criar funções dummy para evitar erros
        window.signInWithGoogle = async () => {
          throw new Error("Firebase não inicializado");
        };
        window.signOutUser = () => {};
        window.getCurrentUser = () => null;
        window.authorizedEmails = [];
        window.dbOperations = {
          getProducts: async () => [],
          getSales: async () => [],
          getCart: async () => [],
          saveCart: async () => {},
          addProduct: async () => {},
          updateProduct: async () => {},
          deleteProduct: async () => {},
          addSale: async () => {},
          clearAllSales: async () => {}
        };
      }
    </script>
    
    <style>
        /* ESTILOS ANTERIORES MANTIDOS - Vou resumir para não repetir todo o CSS */
        /* Todos os estilos anteriores permanecem aqui */
        /* Adicionando apenas correções específicas */
        
        /* Correção para o loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Correção para mensagens de erro */
        .error-message {
            background-color: #fee;
            border: 1px solid #f99;
            color: #c00;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        /* Ajuste para o modal de login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }

        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Botão de login melhorado */
        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            width: 100%;
            padding: 1rem;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .google-login-btn:hover {
            background: #357ae8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        
        .google-login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Indicador de carregamento no login */
        .login-loading {
            display: none;
            text-align: center;
            color: #64748b;
            margin-top: 1rem;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .login-loading.active {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo" style="font-size: 2rem; font-weight: 700; color: #1a1a1a; margin-bottom: 1.5rem;">
                <i class="fas fa-store"></i> PDV Adega
            </div>
            <h1 class="login-title" style="font-size: 1.5rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem;">
                Bem-vindo ao PDV Adega
            </h1>
            <p class="login-subtitle" style="color: #64748b; margin-bottom: 2rem;">
                Faça login com sua conta Google autorizada para acessar o sistema
            </p>
            
            <button id="googleLoginBtn" class="google-login-btn">
                <i class="fab fa-google"></i>
                Entrar com Google
            </button>
            
            <div id="loginError" class="error-message"></div>
            
            <div id="loginLoading" class="login-loading">
                <div class="loader"></div>
                <div>Autenticando...</div>
            </div>
            
            <p style="font-size: 0.875rem; color: #64748b; margin-top: 1.5rem;">
                <i class="fas fa-info-circle"></i> Apenas emails autorizados podem acessar o sistema.
            </p>
            
            <div id="firebaseStatus" style="margin-top: 1rem; font-size: 0.75rem; color: #94a3b8;">
                <i class="fas fa-circle" style="color: #ef4444;"></i> Conectando ao Firebase...
            </div>
        </div>
    </div>

    <!-- Sistema PDV (apenas para usuários autenticados) -->
    <div id="pdvSystem" style="display: none;">
        <!-- O restante do código do PDV permanece aqui -->
        <!-- Para economizar espaço, vou manter apenas o esqueleto -->
        <header>
            <div class="logo"><i class="fas fa-store"></i> PDV Adega</div>
            <div class="tabs">
                <button class="tab-btn active" data-tab="pdv">PDV</button>
                <button class="tab-btn" data-tab="historico">Histórico</button>
                <button class="tab-btn" data-tab="cadastro">Cadastro</button>
                <button class="tab-btn" data-tab="notepad">Notepad</button>
            </div>
            <div class="user-info" id="userInfo">
                <!-- Preenchido dinamicamente -->
            </div>
        </header>

        <div class="container">
            <!-- Conteúdo das abas -->
            <div id="pdv-tab" class="tab-content active">
                <!-- Conteúdo do PDV -->
            </div>
            
            <div id="historico-tab" class="tab-content">
                <!-- Conteúdo do Histórico -->
            </div>
            
            <div id="cadastro-tab" class="tab-content">
                <!-- Conteúdo do Cadastro -->
            </div>
            
            <div id="notepad-tab" class="tab-content">
                <!-- Conteúdo do Notepad -->
            </div>
        </div>
    </div>

    <!-- Sistema de Notificações -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ===== SISTEMA DE LOGIN CORRIGIDO =====
        
        // Variáveis globais
        let produtosCache = [];
        let carrinhoCache = [];
        let historicoCache = [];
        let notepadNotes = [];
        let currentUser = null;
        let firebaseReady = false;

        // ===== FUNÇÕES AUXILIARES =====
        
        function formatarMoeda(valor) {
            if (isNaN(valor) || valor === null || valor === undefined) {
                valor = 0;
            }
            return Number(valor).toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function gerarId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = '';
            switch(type) {
                case 'success': icon = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-triangle"></i>'; break;
                default: icon = '<i class="fas fa-info-circle"></i>';
            }
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <div class="toast-content">
                    <span class="toast-message">${message}</span>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                toast.remove();
            });
            
            toastContainer.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, duration);
            }
        }

        // ===== SISTEMA DE AUTENTICAÇÃO CORRIGIDO =====
        
        function setupAuth() {
            console.log("Configurando autenticação...");
            
            const loginScreen = document.getElementById('loginScreen');
            const pdvSystem = document.getElementById('pdvSystem');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const loginError = document.getElementById('loginError');
            const loginLoading = document.getElementById('loginLoading');
            const firebaseStatus = document.getElementById('firebaseStatus');

            // Atualizar status do Firebase
            function updateFirebaseStatus(ready) {
                if (firebaseStatus) {
                    if (ready) {
                        firebaseStatus.innerHTML = '<i class="fas fa-circle" style="color: #10b981;"></i> Firebase conectado';
                    } else {
                        firebaseStatus.innerHTML = '<i class="fas fa-circle" style="color: #ef4444;"></i> Firebase não disponível';
                    }
                }
            }

            // Verificar se Firebase está pronto
            window.addEventListener('firebaseReady', () => {
                console.log("Firebase está pronto!");
                firebaseReady = true;
                updateFirebaseStatus(true);
                checkAuthState();
            });

            // Tentativa de verificação após timeout
            setTimeout(() => {
                if (!firebaseReady) {
                    console.warn("Firebase não carregou após timeout");
                    updateFirebaseStatus(false);
                    showLoginError("Firebase não inicializou. Verifique a conexão.");
                }
            }, 5000);

            // Verificar estado de autenticação
            function checkAuthState() {
                try {
                    const user = window.getCurrentUser ? window.getCurrentUser() : null;
                    const authorizedEmails = window.authorizedEmails || [];
                    
                    console.log("Verificando autenticação:", user ? user.email : "Nenhum usuário");
                    
                    if (user && authorizedEmails.includes(user.email)) {
                        console.log("Usuário autorizado detectado");
                        currentUser = user;
                        showPDVSystem();
                        updateUserInfo(user);
                        initPDVSystem();
                    } else {
                        console.log("Mostrando tela de login");
                        showLoginScreen();
                    }
                } catch (error) {
                    console.error("Erro ao verificar autenticação:", error);
                    showLoginScreen();
                }
            }

            // Listener para mudanças de autenticação
            window.addEventListener('authStateChanged', (e) => {
                console.log("Evento authStateChanged recebido:", e.detail);
                const { user, loggedIn } = e.detail;
                const authorizedEmails = window.authorizedEmails || [];
                
                if (loggedIn && user && authorizedEmails.includes(user.email)) {
                    console.log("Usuário autorizado logado via evento");
                    currentUser = user;
                    showPDVSystem();
                    updateUserInfo(user);
                    initPDVSystem();
                } else {
                    console.log("Usuário deslogado ou não autorizado via evento");
                    currentUser = null;
                    showLoginScreen();
                }
            });

            // Configurar botão de login
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', async () => {
                    if (!firebaseReady) {
                        showLoginError("Firebase não está pronto. Aguarde...");
                        return;
                    }
                    
                    loginError.style.display = 'none';
                    loginError.textContent = '';
                    loginLoading.classList.add('active');
                    googleLoginBtn.disabled = true;
                    
                    try {
                        console.log("Iniciando processo de login...");
                        const user = await window.signInWithGoogle();
                        console.log("Login bem-sucedido para:", user.email);
                        
                        // O evento authStateChanged vai lidar com o resto
                        
                    } catch (error) {
                        console.error("Erro no login:", error);
                        let errorMessage = error.message || 'Erro ao fazer login.';
                        
                        if (error.code === 'auth/popup-blocked') {
                            errorMessage = 'Pop-up bloqueado. Por favor, permita pop-ups para este site.';
                        } else if (error.code === 'auth/popup-closed-by-user') {
                            errorMessage = 'Login cancelado pelo usuário.';
                        } else if (error.code === 'auth/unauthorized-domain') {
                            errorMessage = 'Domínio não autorizado. Verifique as configurações do Firebase.';
                        }
                        
                        showLoginError(errorMessage);
                    } finally {
                        loginLoading.classList.remove('active');
                        googleLoginBtn.disabled = false;
                    }
                });
            }

            // Funções para mostrar/ocultar telas
            function showLoginScreen() {
                console.log("Mostrando tela de login");
                if (loginScreen) {
                    loginScreen.style.display = 'flex';
                    loginScreen.style.opacity = '1';
                }
                if (pdvSystem) pdvSystem.style.display = 'none';
            }

            function showPDVSystem() {
                console.log("Mostrando sistema PDV");
                if (loginScreen) {
                    loginScreen.style.opacity = '0';
                    setTimeout(() => {
                        loginScreen.style.display = 'none';
                    }, 300);
                }
                if (pdvSystem) pdvSystem.style.display = 'block';
            }

            function showLoginError(message) {
                if (loginError) {
                    loginError.textContent = message;
                    loginError.style.display = 'block';
                }
                showToast(message, 'error');
            }

            // Inicializar verificação
            checkAuthState();
        }

        function updateUserInfo(user) {
            const userInfo = document.getElementById('userInfo');
            if (!userInfo) return;
            
            const displayName = user.displayName || user.email.split('@')[0];
            
            userInfo.innerHTML = `
                <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(displayName) + '&background=4f46e5&color=fff'}" 
                     class="user-avatar" alt="${displayName}">
                <div class="user-email">${displayName}</div>
                <button class="logout-btn" id="logoutBtn" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            `;
            
            // Adicionar evento ao botão de logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await window.signOutUser();
                        showToast("Deslogado com sucesso!", 'success');
                    } catch (error) {
                        console.error("Erro ao deslogar:", error);
                        showToast("Erro ao deslogar", 'error');
                    }
                });
            }
        }

        // ===== INICIALIZAÇÃO DO PDV =====
        
        async function initPDVSystem() {
            console.log("Inicializando sistema PDV para:", currentUser.email);
            
            try {
                // Carregar dados iniciais
                await loadInitialData();
                
                // Configurar interface
                setupPDVInterface();
                
                // Mostrar mensagem de boas-vindas
                showToast(`Bem-vindo, ${currentUser.displayName || currentUser.email.split('@')[0]}!`, 'success');
                
            } catch (error) {
                console.error("Erro na inicialização do PDV:", error);
                showToast("Erro ao carregar o sistema. Recarregue a página.", 'error');
            }
        }

        async function loadInitialData() {
            console.log("Carregando dados iniciais...");
            
            try {
                // Tentar carregar do Firebase
                if (window.dbOperations && currentUser) {
                    console.log("Carregando do Firebase...");
                    const [produtos, carrinho, historico] = await Promise.all([
                        window.dbOperations.getProducts().catch(e => {
                            console.warn("Erro ao carregar produtos do Firebase:", e);
                            return getFromLocalStorage('produtosCache');
                        }),
                        window.dbOperations.getCart().catch(e => {
                            console.warn("Erro ao carregar carrinho do Firebase:", e);
                            return getFromLocalStorage('carrinhoCache');
                        }),
                        window.dbOperations.getSales().catch(e => {
                            console.warn("Erro ao carregar histórico do Firebase:", e);
                            return getFromLocalStorage('historicoCache');
                        })
                    ]);
                    
                    produtosCache = produtos || [];
                    carrinhoCache = carrinho || [];
                    historicoCache = historico || [];
                } else {
                    // Carregar do localStorage
                    console.log("Carregando do localStorage...");
                    produtosCache = getFromLocalStorage('produtosCache');
                    carrinhoCache = getFromLocalStorage('carrinhoCache');
                    historicoCache = getFromLocalStorage('historicoCache');
                }
                
                // Carregar Notepad
                notepadNotes = getFromLocalStorage('adegaNotepad');
                
                console.log("Dados carregados:", {
                    produtos: produtosCache.length,
                    carrinho: carrinhoCache.length,
                    historico: historicoCache.length,
                    notepad: notepadNotes.length
                });
                
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                // Inicializar arrays vazios
                produtosCache = [];
                carrinhoCache = [];
                historicoCache = [];
                notepadNotes = [];
            }
        }

        function getFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error(`Erro ao ler ${key} do localStorage:`, error);
                return [];
            }
        }

        function setupPDVInterface() {
            console.log("Configurando interface PDV...");
            
            // Configurar eventos básicos
            setupBasicEvents();
            
            // Inicializar componentes
            initializeComponents();
            
            // Focar no campo de busca se estiver na aba PDV
            const searchInput = document.getElementById('searchInput');
            if (searchInput && document.getElementById('pdv-tab')?.classList.contains('active')) {
                searchInput.focus();
            }
        }

        function setupBasicEvents() {
            // Busca de produtos
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    // Implementar busca
                });
            }

            // Botões de venda
            const finalizarVendaBtn = document.getElementById('finalizarVenda');
            if (finalizarVendaBtn) {
                finalizarVendaBtn.addEventListener('click', () => {
                    showToast("Funcionalidade de venda em desenvolvimento", 'info');
                });
            }

            // Tabs
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const targetTab = document.getElementById(`${tabId}-tab`);
                    if (targetTab) targetTab.classList.add('active');
                    
                    if (tabId === 'pdv' && searchInput) {
                        searchInput.focus();
                    }
                });
            });
        }

        function initializeComponents() {
            // Inicializar componentes aqui
            console.log("Componentes inicializados");
        }

        // ===== INICIALIZAÇÃO DO SISTEMA =====
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM carregado, inicializando sistema...");
            
            // Iniciar sistema de autenticação
            setupAuth();
            
            // Configurar atalhos de teclado básicos
            setupKeyboardShortcuts();
            
            // Mostrar mensagem inicial
            setTimeout(() => {
                if (document.getElementById('loginScreen')?.style.display !== 'none') {
                    showToast("Sistema PDV Adega carregado", 'info', 3000);
                }
            }, 1000);
        });

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch(e.key) {
                    case 'F1':
                        e.preventDefault();
                        showToast("Atalhos: F2-Dinheiro, F3-Débito, F4-Crédito, F5-PIX, F9-Finalizar, F10-Cancelar", 'info', 5000);
                        break;
                    case 'Escape':
                        // Fechar modais se houver
                        break;
                }
            });
        }

        // ===== FUNÇÕES GLOBAIS PARA TESTE =====
        
        // Função para testar login manualmente
        window.testLogin = async (email, password) => {
            // Esta é uma função de teste, em produção use apenas Google Auth
            console.log("Teste de login manual desativado. Use Google Auth.");
            showToast("Use o botão 'Entrar com Google'", 'warning');
        };

        // Função para forçar logout
        window.forceLogout = async () => {
            try {
                if (window.signOutUser) {
                    await window.signOutUser();
                }
                localStorage.clear();
                location.reload();
            } catch (error) {
                console.error("Erro ao forçar logout:", error);
            }
        };

        // Função para verificar status
        window.checkSystemStatus = () => {
            return {
                firebaseReady,
                currentUser: currentUser ? currentUser.email : null,
                produtosCount: produtosCache.length,
                carrinhoCount: carrinhoCache.length,
                historicoCount: historicoCache.length,
                localStorage: {
                    produtos: localStorage.getItem('produtosCache') ? true : false,
                    carrinho: localStorage.getItem('carrinhoCache') ? true : false,
                    historico: localStorage.getItem('historicoCache') ? true : false
                }
            };
        };

        // Debug helper
        console.log("Sistema PDV Adega carregado. Use checkSystemStatus() para verificar o estado.");
    </script>

    <!-- Adicionando CSS para toast notifications -->
    <style>
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            color: white;
            font-weight: 500;
        }
        
        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .toast-icon {
            font-size: 18px;
        }
        
        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</body>
</html>
