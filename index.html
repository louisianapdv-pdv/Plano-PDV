<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Adega</title>
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="logo.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas externas -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK - VERS√ÉO SIMPLIFICADA E CORRIGIDA -->
    <script type="module">
      // Verificar se Firebase j√° foi carregado
      if (!window.firebaseLoaded) {
        window.firebaseLoaded = true;
        
        console.log("üöÄ Iniciando carga do Firebase...");

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyBuob65d4nwic1hXTGSsLtc38dEoD1H0zU",
          authDomain: "pdv26-aa76b.firebaseapp.com",
          projectId: "pdv26-aa76b",
          storageBucket: "pdv26-aa76b.appspot.com",
          messagingSenderId: "885941177258",
          appId: "1:885941177258:web:98f2690e07ec0a087cf9d3",
          measurementId: "G-6BT5HW6JV8"
        };

        // Lista de emails autorizados
        const authorizedEmails = [
          "pablohenriquerodriguesgracioli@gmail.com",
          "admin@adega.com",
          "vendedor@adega.com",
          "teste@adega.com",
          "seuemail@gmail.com" // Adicione seu email aqui para testar
        ];

        // Fun√ß√µes dummy como fallback
        const dummyFunctions = {
          signInWithGoogle: async () => {
            // Simular login para desenvolvimento
            const dummyUser = {
              uid: 'dummy-' + Date.now(),
              email: 'teste@adega.com',
              displayName: 'Usu√°rio Teste',
              photoURL: ''
            };
            
            // Simular delay de rede
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (!authorizedEmails.includes(dummyUser.email)) {
              throw new Error("Email n√£o autorizado para acessar o sistema.");
            }
            
            window.currentUser = dummyUser;
            window.dispatchEvent(new CustomEvent('authStateChanged', { 
              detail: { user: dummyUser, loggedIn: true } 
            }));
            
            return dummyUser;
          },
          
          signOutUser: () => {
            window.currentUser = null;
            window.dispatchEvent(new CustomEvent('authStateChanged', { 
              detail: { user: null, loggedIn: false } 
            }));
            return Promise.resolve();
          },
          
          getCurrentUser: () => window.currentUser,
          
          dbOperations: {
            getProducts: async () => {
              const produtos = JSON.parse(localStorage.getItem('produtosCache') || '[]');
              console.log("Carregando produtos do localStorage:", produtos.length);
              return produtos;
            },
            
            getSales: async () => {
              const vendas = JSON.parse(localStorage.getItem('historicoCache') || '[]');
              console.log("Carregando vendas do localStorage:", vendas.length);
              return vendas;
            },
            
            getCart: async () => {
              const carrinho = JSON.parse(localStorage.getItem('carrinhoCache') || '[]');
              console.log("Carregando carrinho do localStorage:", carrinho.length);
              return carrinho;
            },
            
            saveCart: async (cart) => {
              localStorage.setItem('carrinhoCache', JSON.stringify(cart));
              console.log("Carrinho salvo no localStorage:", cart.length);
              return Promise.resolve();
            },
            
            addProduct: async (product) => {
              const produtos = JSON.parse(localStorage.getItem('produtosCache') || '[]');
              produtos.push(product);
              localStorage.setItem('produtosCache', JSON.stringify(produtos));
              console.log("Produto salvo no localStorage:", product.nome);
              return Promise.resolve();
            },
            
            updateProduct: async (id, product) => {
              const produtos = JSON.parse(localStorage.getItem('produtosCache') || '[]');
              const index = produtos.findIndex(p => p.id === id);
              if (index !== -1) {
                produtos[index] = { ...produtos[index], ...product };
                localStorage.setItem('produtosCache', JSON.stringify(produtos));
              }
              return Promise.resolve();
            },
            
            deleteProduct: async (id) => {
              const produtos = JSON.parse(localStorage.getItem('produtosCache') || '[]');
              const novosProdutos = produtos.filter(p => p.id !== id);
              localStorage.setItem('produtosCache', JSON.stringify(novosProdutos));
              return Promise.resolve();
            },
            
            addSale: async (sale) => {
              const vendas = JSON.parse(localStorage.getItem('historicoCache') || '[]');
              vendas.unshift(sale);
              localStorage.setItem('historicoCache', JSON.stringify(vendas));
              console.log("Venda salva no localStorage:", sale.total);
              return Promise.resolve();
            },
            
            clearAllSales: async () => {
              localStorage.setItem('historicoCache', '[]');
              return Promise.resolve();
            }
          }
        };

        // Tentar carregar Firebase dinamicamente
        async function loadFirebase() {
          try {
            console.log("Tentando carregar m√≥dulos do Firebase...");
            
            // Carregar m√≥dulos do Firebase
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
            const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = 
                  await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
            const { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy, serverTimestamp } = 
                  await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

            console.log("M√≥dulos do Firebase carregados com sucesso!");
            
            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const provider = new GoogleAuthProvider();

            // Configurar provedor do Google
            provider.setCustomParameters({
              prompt: 'select_account'
            });

            // ===== FUN√á√ïES DO FIREBASE =====
            
            // Fun√ß√£o de login com Google
            window.signInWithGoogle = async () => {
              try {
                console.log("Iniciando login com Google...");
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Usu√°rio autenticado:", user.email);
                
                if (!authorizedEmails.includes(user.email)) {
                  console.log("Email n√£o autorizado:", user.email);
                  await signOut(auth);
                  throw new Error("Email n√£o autorizado para acessar o sistema.");
                }
                
                console.log("Login bem-sucedido!");
                return user;
              } catch (error) {
                console.error("Erro no login Firebase:", error);
                // Fallback para modo dummy
                console.log("Usando modo fallback...");
                return dummyFunctions.signInWithGoogle();
              }
            };

            // Fun√ß√£o de logout
            window.signOutUser = async () => {
              try {
                await signOut(auth);
                console.log("Usu√°rio deslogado do Firebase");
              } catch (error) {
                console.error("Erro ao deslogar do Firebase:", error);
                // Fallback
                return dummyFunctions.signOutUser();
              }
            };

            // Obter usu√°rio atual
            window.getCurrentUser = () => auth.currentUser;

            // Monitorar estado de autentica√ß√£o
            onAuthStateChanged(auth, (user) => {
              console.log("Estado de autentica√ß√£o Firebase alterado:", user ? user.email : "Nenhum usu√°rio");
              
              if (user && authorizedEmails.includes(user.email)) {
                window.currentUser = user;
                window.dispatchEvent(new CustomEvent('authStateChanged', { 
                  detail: { user, loggedIn: true } 
                }));
              } else {
                window.currentUser = null;
                window.dispatchEvent(new CustomEvent('authStateChanged', { 
                  detail: { user: null, loggedIn: false } 
                }));
              }
            });

            // ===== OPERA√á√ïES DO FIRESTORE =====
            
            // Fun√ß√µes para Produtos
            async function addProduct(product) {
              try {
                const user = auth.currentUser;
                if (!user || !authorizedEmails.includes(user.email)) {
                  throw new Error("N√£o autorizado");
                }
                
                const productRef = doc(collection(db, "products"));
                const productData = {
                  ...product,
                  id: productRef.id,
                  createdBy: user.uid,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp()
                };
                
                await setDoc(productRef, productData);
                console.log("Produto adicionado ao Firebase:", productRef.id);
                
                // Tamb√©m salvar localmente
                dummyFunctions.dbOperations.addProduct(productData);
                
                return productRef.id;
              } catch (error) {
                console.error("Erro ao adicionar produto no Firebase:", error);
                // Fallback para localStorage
                return dummyFunctions.dbOperations.addProduct(product);
              }
            }

            async function getProducts() {
              try {
                const user = auth.currentUser;
                if (!user || !authorizedEmails.includes(user.email)) {
                  console.log("Usu√°rio n√£o autorizado, usando localStorage");
                  return dummyFunctions.dbOperations.getProducts();
                }
                
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const products = querySnapshot.docs.map(doc => ({ 
                  id: doc.id, 
                  ...doc.data() 
                }));
                
                console.log("Produtos carregados do Firebase:", products.length);
                
                // Sincronizar com localStorage
                localStorage.setItem('produtosCache', JSON.stringify(products));
                
                return products;
              } catch (error) {
                console.error("Erro ao buscar produtos do Firebase:", error);
                // Fallback para localStorage
                return dummyFunctions.dbOperations.getProducts();
              }
            }

            async function addSale(sale) {
              try {
                const user = auth.currentUser;
                if (!user || !authorizedEmails.includes(user.email)) {
                  throw new Error("N√£o autorizado");
                }
                
                const saleRef = doc(collection(db, "sales"));
                const saleData = {
                  ...sale,
                  id: saleRef.id,
                  userId: user.uid,
                  userEmail: user.email,
                  userName: user.displayName || user.email.split('@')[0],
                  createdAt: serverTimestamp(),
                  date: new Date().toISOString().split('T')[0],
                  timestamp: Date.now()
                };
                
                await setDoc(saleRef, saleData);
                console.log("Venda registrada no Firebase:", saleRef.id);
                
                // Tamb√©m salvar localmente
                dummyFunctions.dbOperations.addSale(saleData);
                
                return saleRef.id;
              } catch (error) {
                console.error("Erro ao registrar venda no Firebase:", error);
                // Fallback para localStorage
                return dummyFunctions.dbOperations.addSale(sale);
              }
            }

            async function getSales() {
              try {
                const user = auth.currentUser;
                if (!user || !authorizedEmails.includes(user.email)) {
                  console.log("Usu√°rio n√£o autorizado, usando localStorage");
                  return dummyFunctions.dbOperations.getSales();
                }
                
                const q = query(collection(db, "sales"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const sales = querySnapshot.docs.map(doc => ({ 
                  id: doc.id, 
                  ...doc.data() 
                }));
                
                console.log("Vendas carregadas do Firebase:", sales.length);
                
                // Sincronizar com localStorage
                localStorage.setItem('historicoCache', JSON.stringify(sales));
                
                return sales;
              } catch (error) {
                console.error("Erro ao buscar vendas do Firebase:", error);
                // Fallback para localStorage
                return dummyFunctions.dbOperations.getSales();
              }
            }

            async function saveCart(cart) {
              try {
                const user = auth.currentUser;
                if (!user || !authorizedEmails.includes(user.email)) {
                  console.log("Usu√°rio n√£o autorizado, salvando apenas localmente");
                  return dummyFunctions.dbOperations.saveCart(cart);
                }
                
                const cartRef = doc(db, "carts", user.uid);
                await setDoc(cartRef, {
                  items: cart,
                  userId: user.uid,
                  userEmail: user.email,
                  updatedAt: serverTimestamp()
                });
                console.log("Carrinho salvo no Firebase para:", user.email);
                
                // Tamb√©m salvar localmente
                dummyFunctions.dbOperations.saveCart(cart);
                
              } catch (error) {
                console.error("Erro ao salvar carrinho no Firebase:", error);
                // Fallback para localStorage
                return dummyFunctions.dbOperations.saveCart(cart);
              }
            }

            async function getCart() {
              try {
                const user = auth.currentUser;
                if (!user || !authorizedEmails.includes(user.email)) {
                  console.log("Usu√°rio n√£o autorizado, usando localStorage");
                  return dummyFunctions.dbOperations.getCart();
                }
                
                const cartRef = doc(db, "carts", user.uid);
                const docSnap = await getDoc(cartRef);
                
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  const items = data.items || [];
                  console.log("Carrinho carregado do Firebase:", items.length);
                  
                  // Sincronizar com localStorage
                  localStorage.setItem('carrinhoCache', JSON.stringify(items));
                  
                  return items;
                } else {
                  console.log("Carrinho n√£o encontrado no Firebase");
                  return [];
                }
              } catch (error) {
                console.error("Erro ao buscar carrinho do Firebase:", error);
                // Fallback para localStorage
                return dummyFunctions.dbOperations.getCart();
              }
            }

            // Exportar fun√ß√µes
            window.dbOperations = {
              addProduct,
              updateProduct: async (id, product) => {
                try {
                  const user = auth.currentUser;
                  if (!user || !authorizedEmails.includes(user.email)) {
                    throw new Error("N√£o autorizado");
                  }
                  
                  const productRef = doc(db, "products", id);
                  await updateDoc(productRef, {
                    ...product,
                    updatedAt: serverTimestamp()
                  });
                  
                  // Atualizar localmente
                  dummyFunctions.dbOperations.updateProduct(id, product);
                } catch (error) {
                  console.error("Erro ao atualizar produto no Firebase:", error);
                  // Fallback
                  return dummyFunctions.dbOperations.updateProduct(id, product);
                }
              },
              
              deleteProduct: async (id) => {
                try {
                  const user = auth.currentUser;
                  if (!user || !authorizedEmails.includes(user.email)) {
                    throw new Error("N√£o autorizado");
                  }
                  
                  await deleteDoc(doc(db, "products", id));
                  
                  // Atualizar localmente
                  dummyFunctions.dbOperations.deleteProduct(id);
                } catch (error) {
                  console.error("Erro ao deletar produto do Firebase:", error);
                  // Fallback
                  return dummyFunctions.dbOperations.deleteProduct(id);
                }
              },
              
              getProducts,
              addSale,
              getSales,
              
              clearAllSales: async () => {
                try {
                  const user = auth.currentUser;
                  if (!user || !authorizedEmails.includes(user.email)) {
                    throw new Error("N√£o autorizado");
                  }
                  
                  const sales = await getSales();
                  const deletePromises = sales.map(sale => 
                    deleteDoc(doc(db, "sales", sale.id))
                  );
                  await Promise.all(deletePromises);
                  
                  // Limpar localmente
                  dummyFunctions.dbOperations.clearAllSales();
                } catch (error) {
                  console.error("Erro ao limpar vendas do Firebase:", error);
                  // Fallback
                  return dummyFunctions.dbOperations.clearAllSales();
                }
              },
              
              saveCart,
              getCart
            };

            window.authorizedEmails = authorizedEmails;
            window.firebaseApp = app;
            window.firebaseAuth = auth;
            window.firebaseDB = db;
            window.firebaseProvider = provider;
            
            console.log("‚úÖ Firebase inicializado com sucesso!");
            window.firebaseReady = true;
            
          } catch (error) {
            console.error("‚ùå Erro ao carregar Firebase:", error);
            console.log("‚ö†Ô∏è Usando modo fallback (localStorage)");
            
            // Configurar fun√ß√µes dummy
            window.signInWithGoogle = dummyFunctions.signInWithGoogle;
            window.signOutUser = dummyFunctions.signOutUser;
            window.getCurrentUser = dummyFunctions.getCurrentUser;
            window.dbOperations = dummyFunctions.dbOperations;
            window.authorizedEmails = authorizedEmails;
            window.firebaseReady = true; // Marcar como pronto mesmo no fallback
          }
          
          // Disparar evento que Firebase est√° pronto
          window.dispatchEvent(new Event('firebaseReady'));
        }

        // Iniciar carga do Firebase
        loadFirebase();

      } else {
        console.log("Firebase j√° est√° sendo carregado...");
      }
    </script>
    
    <style>
        /* Estilos gerais - MANTIDOS DO C√ìDIGO ANTERIOR */
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #333;
            --accent-color: #4f46e5;
            --light-color: #f8fafc;
            --danger-color: #ef4444;
            --success-color: #10b981;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f1f5f9;
            color: #1e293b;
            min-height: 100vh;
        }
        
        /* Tela de Login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
        }
        
        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-logo {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }
        
        .login-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .login-subtitle {
            color: #64748b;
            margin-bottom: 2rem;
        }
        
        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            width: 100%;
            padding: 1rem;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .google-login-btn:hover {
            background: #357ae8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        
        .google-login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            display: none;
        }
        
        .login-loading {
            display: none;
            text-align: center;
            color: #64748b;
            margin-top: 1rem;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: white;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 2px;
        }
        
        .tab-btn {
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.375rem;
            color: white;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .tab-btn.active {
            background-color: white;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .user-email {
            font-size: 0.875rem;
            color: white;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Container principal */
        .container {
            flex: 1;
            max-width: 1400px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Tabs content */
        .tab-content {
            display: none;
            flex: 1;
            gap: 1.5rem;
            height: 100%;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* Se√ß√£o de produtos */
        .produtos-section {
            flex: 2;
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .section-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .search-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .search-bar {
            flex: 1;
            padding: 0.625rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .search-bar:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        
        .search-barcode-btn {
            padding: 0.625rem;
            background-color: var(--primary-color);
            color: white;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .categorias {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.25rem;
        }
        
        .categoria-btn {
            padding: 0.375rem 0.75rem;
            background-color: #f1f5f9;
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.8125rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .categoria-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .produtos-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 0.25rem;
        }
        
        .produto-card {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 180px;
            max-width: 180px;
            height: 250px;
        }
        
        .produto-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
        }
        
        .produto-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 0.75rem;
        }
        
        .produto-info {
            margin-top: auto;
        }
        
        .produto-nome {
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .produto-preco {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9375rem;
        }
        
        .produto-estoque {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 0.75rem;
            font-size: 0.6875rem;
            font-weight: 500;
        }
        
        .estoque-baixo {
            background-color: rgba(239, 68, 68, 0.9);
        }
        
        /* Se√ß√£o de venda */
        .venda-section {
            flex: 1;
            min-width: 350px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .venda-section .section-title {
            border-bottom-color: #475569;
            color: white;
        }
        
        .itens-venda {
            margin: 1rem 0;
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .item-venda {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .item-info {
            flex: 1;
            min-width: 0;
        }
        
        .item-nome {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-details {
            font-size: 0.75rem;
            color: #cbd5e1;
            margin-top: 0.125rem;
        }
        
        .item-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .quantidade-controller {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quantidade-controller button {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .total-section {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        
        .total-value {
            font-weight: 600;
        }
        
        .btn {
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
        }
        
        .btn-accent:hover {
            background-color: #4338ca;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            border: 1px solid var(--danger-color);
        }
        
        .btn-block {
            display: block;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        /* Formul√°rios */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            color: white;
            font-weight: 500;
        }
        
        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.7;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsividade */
        @media (max-width: 1024px) {
            .tab-content.active {
                flex-direction: column;
            }
            
            .produtos-section, .venda-section {
                width: 100%;
            }
            
            .venda-section {
                min-width: auto;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
            }
            
            .produto-card {
                min-width: 150px;
                max-width: 150px;
                height: 230px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .produto-card {
                min-width: 140px;
                max-width: 140px;
                height: 220px;
            }
            
            .search-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-store"></i> PDV Adega
            </div>
            <h1 class="login-title">Bem-vindo ao PDV Adega</h1>
            <p class="login-subtitle">Fa√ßa login com sua conta Google autorizada para acessar o sistema</p>
            
            <button id="googleLoginBtn" class="google-login-btn">
                <i class="fab fa-google"></i>
                Entrar com Google
            </button>
            
            <!-- Bot√£o de modo teste (para desenvolvimento) -->
            <button id="testLoginBtn" class="google-login-btn" style="background-color: #10b981;">
                <i class="fas fa-user-check"></i>
                Entrar como Usu√°rio Teste
            </button>
            
            <div id="loginError" class="login-error"></div>
            
            <div id="loginLoading" class="login-loading">
                <div class="loader"></div>
                <div>Autenticando...</div>
            </div>
            
            <p style="font-size: 0.875rem; color: #64748b; margin-top: 1.5rem;">
                <i class="fas fa-info-circle"></i> Apenas emails autorizados podem acessar o sistema.
            </p>
            
            <div id="firebaseStatus" style="margin-top: 1rem; padding: 0.5rem; background-color: #f1f5f9; border-radius: 0.375rem; font-size: 0.75rem;">
                <div id="statusText">Carregando Firebase...</div>
                <div id="statusDetail" style="color: #64748b;"></div>
            </div>
        </div>
    </div>

    <!-- Sistema PDV -->
    <div id="pdvSystem" style="display: none;">
        <header>
            <div class="logo"><i class="fas fa-store"></i> PDV Adega</div>
            <div class="tabs">
                <button class="tab-btn active" data-tab="pdv">PDV</button>
                <button class="tab-btn" data-tab="historico">Hist√≥rico</button>
                <button class="tab-btn" data-tab="cadastro">Cadastro</button>
                <button class="tab-btn" data-tab="notepad">Notepad</button>
            </div>
            <div class="user-info" id="userInfo">
                <!-- Preenchido dinamicamente -->
            </div>
        </header>

        <div class="container">
            <!-- Aba do PDV -->
            <div id="pdv-tab" class="tab-content active">
                <section class="produtos-section">
                    <h2 class="section-title">Produtos Dispon√≠veis</h2>
                    
                    <div class="search-container">
                        <input type="text" class="search-bar" placeholder="Buscar produtos..." id="searchInput" autofocus>
                        <button class="search-barcode-btn" id="scanBarcodeBtn">
                            <i class="fas fa-barcode"></i>
                            C√≥digo
                        </button>
                    </div>
                    
                    <div class="categorias">
                        <button class="categoria-btn active" data-categoria="todos">Todos</button>
                        <button class="categoria-btn" data-categoria="destilados">Destilados</button>
                        <button class="categoria-btn" data-categoria="cacha√ßas">Cacha√ßas</button>
                        <button class="categoria-btn" data-categoria="gins">Gins</button>
                        <button class="categoria-btn" data-categoria="drinks">Drinks</button>
                        <button class="categoria-btn" data-categoria="cervejas">Cervejas</button>
                    </div>
                    
                    <div class="produtos-grid" id="produtosGrid">
                        <div class="loader"></div>
                    </div>
                </section>
                
                <section class="venda-section">
                    <h2 class="section-title">Venda em Andamento</h2>
                    
                    <div class="itens-venda" id="itensVenda">
                        <p style="text-align: center; color: #cbd5e1;">Nenhum item adicionado</p>
                    </div>
                    
                    <div class="total-section">
                        <div class="total-row">
                            <span>Total:</span>
                            <span class="total-value" id="totalVenda">R$ 0,00</span>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <h3 style="margin: 0 0 0.75rem 0;">Forma de Pagamento</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="btn" data-pagamento="dinheiro">Dinheiro</button>
                                <button class="btn" data-pagamento="debito">D√©bito</button>
                                <button class="btn" data-pagamento="credito">Cr√©dito</button>
                                <button class="btn" data-pagamento="pix">PIX</button>
                            </div>
                        </div>
                        
                        <button class="btn btn-accent btn-block" id="finalizarVenda" style="margin-top: 1rem;">
                            <i class="fas fa-check-circle"></i>
                            FINALIZAR VENDA
                        </button>
                        <button class="btn btn-danger btn-block" id="cancelarVenda">
                            <i class="fas fa-times-circle"></i>
                            CANCELAR VENDA
                        </button>
                    </div>
                </section>
            </div>

            <!-- Aba de Hist√≥rico -->
            <div id="historico-tab" class="tab-content">
                <section class="produtos-section">
                    <h2 class="section-title">Hist√≥rico de Vendas</h2>
                    <div style="margin-bottom: 1rem;">
                        <button class="btn btn-danger" id="limparHistoricoBtn">
                            <i class="fas fa-trash"></i> Limpar Hist√≥rico
                        </button>
                        <button class="btn btn-accent" id="exportarExcelBtn" style="margin-left: 0.5rem;">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                    </div>
                    <div id="historicoVendas">
                        <div class="loader"></div>
                    </div>
                </section>
            </div>

            <!-- Aba de Cadastro -->
            <div id="cadastro-tab" class="tab-content">
                <section class="produtos-section">
                    <h2 class="section-title">Cadastro de Produtos</h2>
                    
                    <form id="formProduto" style="margin-bottom: 2rem;">
                        <div class="form-group">
                            <label for="produtoNome">Nome do Produto</label>
                            <input type="text" id="produtoNome" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="produtoPreco">Pre√ßo (R$)</label>
                            <input type="number" id="produtoPreco" class="form-control" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="produtoCategoria">Categoria</label>
                            <select id="produtoCategoria" class="form-control" required>
                                <option value="">Selecione</option>
                                <option value="destilados">Destilados</option>
                                <option value="cacha√ßas">Cacha√ßas</option>
                                <option value="gins">Gins</option>
                                <option value="drinks">Drinks</option>
                                <option value="cervejas">Cervejas</option>
                                <option value="refrigerantes">Refrigerantes</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="produtoEstoque">Estoque</label>
                            <input type="number" id="produtoEstoque" class="form-control" min="0" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="produtoCodigo">C√≥digo de Barras (opcional)</label>
                            <input type="text" id="produtoCodigo" class="form-control">
                        </div>
                        
                        <button type="submit" class="btn btn-accent" id="submitProdutoBtn">
                            <i class="fas fa-save"></i> Cadastrar Produto
                        </button>
                    </form>
                    
                    <h3 class="section-title">Produtos Cadastrados</h3>
                    <div class="produtos-grid" id="produtosCadastrados">
                        <div class="loader"></div>
                    </div>
                </section>
            </div>

            <!-- Aba Notepad -->
            <div id="notepad-tab" class="tab-content">
                <section class="produtos-section">
                    <h2 class="section-title">Notepad Adega</h2>
                    <p>Controle de consumo por cliente</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="notepadCliente">Cliente</label>
                            <input type="text" id="notepadCliente" class="form-control" placeholder="Nome do cliente">
                        </div>
                        <div class="form-group">
                            <label for="notepadProduto">Produto</label>
                            <input type="text" id="notepadProduto" class="form-control" placeholder="Nome do produto">
                        </div>
                        <div class="form-group">
                            <label for="notepadQuantidade">Quantidade</label>
                            <input type="number" id="notepadQuantidade" class="form-control" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label for="notepadPreco">Pre√ßo Unit√°rio</label>
                            <input type="number" id="notepadPreco" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                    
                    <button class="btn btn-accent" id="adicionarNotepadBtn">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                    
                    <div style="margin-top: 2rem;">
                        <h3 class="section-title">Itens Adicionados</h3>
                        <div id="notepadItens">
                            <p style="text-align: center; color: #64748b; padding: 2rem;">Nenhum item adicionado</p>
                        </div>
                        <div style="margin-top: 1rem; text-align: right;">
                            <strong>Total: </strong><span id="notepadTotal">R$ 0,00</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Sistema de Notifica√ß√µes -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ===== VARI√ÅVEIS GLOBAIS =====
        let produtosCache = [];
        let carrinhoCache = [];
        let historicoCache = [];
        let notepadItens = [];
        let currentUser = null;
        let firebaseReady = false;
        let formaPagamento = 'dinheiro';

        // ===== FUN√á√ïES AUXILIARES =====
        
        function formatarMoeda(valor) {
            if (isNaN(valor) || valor === null || valor === undefined) {
                valor = 0;
            }
            return Number(valor).toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function gerarId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = '';
            switch(type) {
                case 'success': icon = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-triangle"></i>'; break;
                default: icon = '<i class="fas fa-info-circle"></i>';
            }
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <div class="toast-content">
                    <span class="toast-message">${message}</span>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                toast.remove();
            });
            
            toastContainer.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, duration);
            }
            
            // Limitar n√∫mero de toasts
            const allToasts = toastContainer.querySelectorAll('.toast');
            if (allToasts.length > 5) {
                allToasts[0].remove();
            }
        }

        // Atualizar status do Firebase
        function updateFirebaseStatus(status, detail = '') {
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            
            if (statusText) statusText.textContent = status;
            if (statusDetail) statusDetail.textContent = detail;
        }

        // ===== SISTEMA DE AUTENTICA√á√ÉO =====
        
        function setupAuth() {
            console.log("Configurando autentica√ß√£o...");
            
            const loginScreen = document.getElementById('loginScreen');
            const pdvSystem = document.getElementById('pdvSystem');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const testLoginBtn = document.getElementById('testLoginBtn');
            const loginError = document.getElementById('loginError');
            const loginLoading = document.getElementById('loginLoading');

            // Aguardar Firebase estar pronto
            window.addEventListener('firebaseReady', () => {
                console.log("Firebase est√° pronto!");
                firebaseReady = true;
                updateFirebaseStatus("‚úÖ Firebase pronto", "Voc√™ j√° pode fazer login");
                
                // Habilitar bot√µes
                if (googleLoginBtn) googleLoginBtn.disabled = false;
                if (testLoginBtn) testLoginBtn.disabled = false;
                
                checkAuthState();
            });

            // Verificar estado de autentica√ß√£o
            function checkAuthState() {
                try {
                    const user = window.getCurrentUser ? window.getCurrentUser() : null;
                    const authorizedEmails = window.authorizedEmails || [];
                    
                    console.log("Verificando autentica√ß√£o:", user ? user.email : "Nenhum usu√°rio");
                    
                    if (user && authorizedEmails.includes(user.email)) {
                        console.log("Usu√°rio autorizado detectado");
                        currentUser = user;
                        showPDVSystem();
                        updateUserInfo(user);
                        initPDVSystem();
                    } else {
                        console.log("Mostrando tela de login");
                        showLoginScreen();
                    }
                } catch (error) {
                    console.error("Erro ao verificar autentica√ß√£o:", error);
                    showLoginScreen();
                }
            }

            // Listener para mudan√ßas de autentica√ß√£o
            window.addEventListener('authStateChanged', (e) => {
                console.log("Evento authStateChanged recebido:", e.detail);
                const { user, loggedIn } = e.detail;
                const authorizedEmails = window.authorizedEmails || [];
                
                if (loggedIn && user && authorizedEmails.includes(user.email)) {
                    console.log("Usu√°rio autorizado logado via evento");
                    currentUser = user;
                    showPDVSystem();
                    updateUserInfo(user);
                    initPDVSystem();
                } else {
                    console.log("Usu√°rio deslogado ou n√£o autorizado via evento");
                    currentUser = null;
                    showLoginScreen();
                }
            });

            // Configurar bot√£o de login Google
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', async () => {
                    if (!firebaseReady) {
                        showLoginError("Firebase ainda n√£o est√° pronto. Aguarde...");
                        updateFirebaseStatus("‚ö†Ô∏è Firebase carregando", "Aguarde alguns segundos");
                        return;
                    }
                    
                    loginError.style.display = 'none';
                    loginError.textContent = '';
                    loginLoading.style.display = 'flex';
                    googleLoginBtn.disabled = true;
                    if (testLoginBtn) testLoginBtn.disabled = true;
                    
                    try {
                        console.log("Iniciando processo de login...");
                        const user = await window.signInWithGoogle();
                        console.log("Login bem-sucedido para:", user.email);
                        
                        showToast(`Bem-vindo, ${user.displayName || user.email}!`, 'success');
                        
                    } catch (error) {
                        console.error("Erro no login:", error);
                        let errorMessage = error.message || 'Erro ao fazer login.';
                        
                        if (error.code === 'auth/popup-blocked') {
                            errorMessage = 'Pop-up bloqueado. Por favor, permita pop-ups para este site.';
                        } else if (error.code === 'auth/popup-closed-by-user') {
                            errorMessage = 'Login cancelado pelo usu√°rio.';
                        } else if (error.code === 'auth/unauthorized-domain') {
                            errorMessage = 'Dom√≠nio n√£o autorizado. Verifique as configura√ß√µes do Firebase.';
                        } else if (error.message.includes('n√£o autorizado')) {
                            errorMessage = 'Seu email n√£o est√° autorizado para acessar o sistema.';
                        }
                        
                        showLoginError(errorMessage);
                    } finally {
                        loginLoading.style.display = 'none';
                        googleLoginBtn.disabled = false;
                        if (testLoginBtn) testLoginBtn.disabled = false;
                    }
                });
            }

            // Configurar bot√£o de login de teste
            if (testLoginBtn) {
                testLoginBtn.addEventListener('click', async () => {
                    if (!firebaseReady) {
                        showLoginError("Sistema ainda n√£o est√° pronto. Aguarde...");
                        return;
                    }
                    
                    loginError.style.display = 'none';
                    loginError.textContent = '';
                    loginLoading.style.display = 'flex';
                    googleLoginBtn.disabled = true;
                    testLoginBtn.disabled = true;
                    
                    try {
                        console.log("Iniciando login de teste...");
                        
                        // Usar fun√ß√£o dummy para login de teste
                        const dummyUser = await window.signInWithGoogle();
                        console.log("Login de teste bem-sucedido para:", dummyUser.email);
                        
                        showToast(`‚úÖ Modo teste ativado! Bem-vindo, ${dummyUser.displayName || dummyUser.email}!`, 'success');
                        
                    } catch (error) {
                        console.error("Erro no login de teste:", error);
                        showLoginError(error.message || 'Erro ao fazer login de teste.');
                    } finally {
                        loginLoading.style.display = 'none';
                        googleLoginBtn.disabled = false;
                        testLoginBtn.disabled = false;
                    }
                });
            }

            // Fun√ß√µes para mostrar/ocultar telas
            function showLoginScreen() {
                console.log("Mostrando tela de login");
                if (loginScreen) loginScreen.style.display = 'flex';
                if (pdvSystem) pdvSystem.style.display = 'none';
            }

            function showPDVSystem() {
                console.log("Mostrando sistema PDV");
                if (loginScreen) loginScreen.style.display = 'none';
                if (pdvSystem) pdvSystem.style.display = 'block';
            }

            function showLoginError(message) {
                if (loginError) {
                    loginError.textContent = message;
                    loginError.style.display = 'block';
                }
                showToast(message, 'error');
            }

            // Inicializar verifica√ß√£o
            setTimeout(() => {
                if (!firebaseReady) {
                    updateFirebaseStatus("‚ö†Ô∏è Firebase demorando", "Usando modo local como fallback");
                    showLoginError("Firebase est√° demorando para carregar. Usando modo local...");
                    
                    // For√ßar ready ap√≥s 10 segundos
                    setTimeout(() => {
                        if (!firebaseReady) {
                            firebaseReady = true;
                            window.dispatchEvent(new Event('firebaseReady'));
                        }
                    }, 10000);
                }
            }, 5000);
            
            // Verificar inicialmente
            setTimeout(checkAuthState, 1000);
        }

        function updateUserInfo(user) {
            const userInfo = document.getElementById('userInfo');
            if (!userInfo) return;
            
            const displayName = user.displayName || user.email.split('@')[0];
            const isTestUser = user.email === 'teste@adega.com';
            
            userInfo.innerHTML = `
                <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(displayName) + '&background=4f46e5&color=fff'}" 
                     class="user-avatar" alt="${displayName}">
                <div class="user-email">
                    ${displayName}
                    ${isTestUser ? ' <span style="font-size: 0.7rem; background: #f59e0b; color: white; padding: 2px 4px; border-radius: 4px;">TESTE</span>' : ''}
                </div>
                <button class="logout-btn" id="logoutBtn" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            `;
            
            // Adicionar evento ao bot√£o de logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await window.signOutUser();
                        showToast("Deslogado com sucesso!", 'success');
                    } catch (error) {
                        console.error("Erro ao deslogar:", error);
                        showToast("Erro ao deslogar", 'error');
                    }
                });
            }
        }

        // ===== SISTEMA PDV =====
        
        async function initPDVSystem() {
            console.log("Inicializando sistema PDV para:", currentUser.email);
            
            try {
                // Carregar dados iniciais
                await loadInitialData();
                
                // Configurar interface
                setupPDVInterface();
                
                // Mostrar mensagem de boas-vindas
                const isTestMode = currentUser.email === 'teste@adega.com';
                const modeText = isTestMode ? ' (Modo Teste - Dados Locais)' : ' (Firebase Conectado)';
                showToast(`‚úÖ Sistema PDV carregado para ${currentUser.displayName || currentUser.email}!${modeText}`, 'success');
                
            } catch (error) {
                console.error("Erro na inicializa√ß√£o do PDV:", error);
                showToast("Erro ao carregar o sistema. Recarregue a p√°gina.", 'error');
            }
        }

        async function loadInitialData() {
            console.log("Carregando dados iniciais...");
            
            try {
                // Carregar produtos
                if (window.dbOperations) {
                    produtosCache = await window.dbOperations.getProducts();
                    console.log("Produtos carregados:", produtosCache.length);
                }
                
                // Carregar carrinho
                if (window.dbOperations) {
                    carrinhoCache = await window.dbOperations.getCart();
                    console.log("Carrinho carregado:", carrinhoCache.length);
                }
                
                // Carregar hist√≥rico
                if (window.dbOperations) {
                    historicoCache = await window.dbOperations.getSales();
                    console.log("Hist√≥rico carregado:", historicoCache.length);
                }
                
                // Carregar notepad do localStorage
                notepadItens = JSON.parse(localStorage.getItem('notepadItens') || '[]');
                
                console.log("‚úÖ Dados carregados:", {
                    produtos: produtosCache.length,
                    carrinho: carrinhoCache.length,
                    historico: historicoCache.length,
                    notepad: notepadItens.length
                });
                
                // Adicionar produtos de exemplo se estiver vazio
                if (produtosCache.length === 0 && currentUser.email === 'teste@adega.com') {
                    console.log("Adicionando produtos de exemplo...");
                    const produtosExemplo = [
                        {
                            id: 'prod1',
                            nome: 'Vodka Absolut',
                            preco: 89.90,
                            categoria: 'destilados',
                            estoque: 15,
                            codigo: '7891234567890'
                        },
                        {
                            id: 'prod2',
                            nome: 'Cacha√ßa 51',
                            preco: 29.90,
                            categoria: 'cacha√ßas',
                            estoque: 25,
                            codigo: '7891234567891'
                        },
                        {
                            id: 'prod3',
                            nome: 'Gin Tanqueray',
                            preco: 149.90,
                            categoria: 'gins',
                            estoque: 8,
                            codigo: '7891234567892'
                        },
                        {
                            id: 'prod4',
                            nome: 'Caipirinha',
                            preco: 18.90,
                            categoria: 'drinks',
                            estoque: 50,
                            codigo: '7891234567893'
                        },
                        {
                            id: 'prod5',
                            nome: 'Heineken',
                            preco: 8.90,
                            categoria: 'cervejas',
                            estoque: 100,
                            codigo: '7891234567894'
                        },
                        {
                            id: 'prod6',
                            nome: 'Whisky Jack Daniels',
                            preco: 129.90,
                            categoria: 'destilados',
                            estoque: 12,
                            codigo: '7891234567895'
                        }
                    ];
                    
                    produtosCache = produtosExemplo;
                    localStorage.setItem('produtosCache', JSON.stringify(produtosCache));
                }
                
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                // Inicializar arrays vazios em caso de erro
                produtosCache = [];
                carrinhoCache = [];
                historicoCache = [];
                notepadItens = [];
                
                // Garantir que existam no localStorage
                localStorage.setItem('produtosCache', '[]');
                localStorage.setItem('carrinhoCache', '[]');
                localStorage.setItem('historicoCache', '[]');
                localStorage.setItem('notepadItens', '[]');
            }
        }

        function setupPDVInterface() {
            console.log("Configurando interface PDV...");
            
            // Renderizar produtos
            renderProdutos();
            
            // Atualizar carrinho
            atualizarCarrinho();
            
            // Renderizar hist√≥rico
            renderHistorico();
            
            // Renderizar produtos cadastrados
            renderProdutosCadastrados();
            
            // Renderizar notepad
            renderNotepad();
            
            // Configurar eventos
            setupEventListeners();
            
            // Focar no campo de busca
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                setTimeout(() => searchInput.focus(), 100);
            }
        }

        // ===== FUN√á√ïES DE RENDERIZA√á√ÉO E L√ìGICA =====
        // (Mantidas do c√≥digo anterior, mas funcionando com o novo sistema)
        
        function renderProdutos() {
            const container = document.getElementById('produtosGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (produtosCache.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; width: 100%; padding: 2rem; color: #64748b;">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhum produto cadastrado</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">V√° para a aba "Cadastro" para adicionar produtos</p>
                    </div>
                `;
                return;
            }
            
            // Filtrar por categoria e busca
            const categoriaAtiva = document.querySelector('.categoria-btn.active')?.dataset.categoria;
            const termoBusca = document.getElementById('searchInput')?.value.toLowerCase() || '';
            
            const produtosFiltrados = produtosCache.filter(produto => {
                const correspondeCategoria = !categoriaAtiva || categoriaAtiva === 'todos' || produto.categoria === categoriaAtiva;
                const correspondeBusca = !termoBusca || 
                    produto.nome.toLowerCase().includes(termoBusca) ||
                    (produto.codigo && produto.codigo.toLowerCase().includes(termoBusca));
                return correspondeCategoria && correspondeBusca;
            });
            
            if (produtosFiltrados.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; width: 100%; padding: 2rem; color: #64748b;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhum produto encontrado</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Tente outra busca ou categoria</p>
                    </div>
                `;
                return;
            }
            
            produtosFiltrados.forEach(produto => {
                const estoqueEsgotado = produto.estoque <= 0;
                
                const produtoCard = document.createElement('div');
                produtoCard.className = 'produto-card';
                if (estoqueEsgotado) {
                    produtoCard.style.opacity = '0.7';
                    produtoCard.style.cursor = 'not-allowed';
                    produtoCard.title = 'Produto esgotado';
                } else {
                    produtoCard.title = `Clique para adicionar ${produto.nome}`;
                }
                
                produtoCard.innerHTML = `
                    <img src="${produto.imagem || 'https://images.unsplash.com/photo-1578916171728-46686eac8d58?w=150&h=120&fit=crop'}" alt="${produto.nome}">
                    <div class="produto-estoque ${produto.estoque < 5 ? 'estoque-baixo' : ''}">
                        ${produto.estoque} ${estoqueEsgotado ? 'ESGOTADO' : 'dispon√≠veis'}
                    </div>
                    <div class="produto-info">
                        <div class="produto-nome">${produto.nome}</div>
                        <div class="produto-preco">${formatarMoeda(produto.preco)}</div>
                        ${produto.codigo ? `<div style="font-size: 0.75rem; color: #64748b;">C√≥d: ${produto.codigo}</div>` : ''}
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                            ${produto.categoria || 'Sem categoria'}
                        </div>
                    </div>
                `;
                
                if (!estoqueEsgotado) {
                    produtoCard.addEventListener('click', () => adicionarAoCarrinho(produto));
                }
                
                container.appendChild(produtoCard);
            });
        }

        async function adicionarAoCarrinho(produto) {
            // Verificar estoque
            if (produto.estoque <= 0) {
                showToast('Produto esgotado!', 'error');
                return;
            }
            
            // Verificar se j√° est√° no carrinho
            const itemExistente = carrinhoCache.find(item => item.id === produto.id);
            
            if (itemExistente) {
                // Verificar se h√° estoque suficiente
                if (itemExistente.quantidade >= produto.estoque) {
                    showToast(`Estoque insuficiente! Restam apenas ${produto.estoque} unidades.`, 'warning');
                    return;
                }
                itemExistente.quantidade += 1;
            } else {
                carrinhoCache.push({
                    id: produto.id,
                    nome: produto.nome,
                    preco: produto.preco,
                    quantidade: 1,
                    categoria: produto.categoria,
                    estoqueAtual: produto.estoque
                });
            }
            
            // Salvar carrinho
            if (window.dbOperations) {
                await window.dbOperations.saveCart(carrinhoCache);
            } else {
                localStorage.setItem('carrinhoCache', JSON.stringify(carrinhoCache));
            }
            
            // Atualizar interface
            atualizarCarrinho();
            
            // Limpar busca
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            
            showToast(`${produto.nome} adicionado ao carrinho`, 'success');
        }

        function atualizarCarrinho() {
            const container = document.getElementById('itensVenda');
            const totalElement = document.getElementById('totalVenda');
            
            if (!container || !totalElement) return;
            
            if (carrinhoCache.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #cbd5e1;">
                        <i class="fas fa-shopping-cart" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhum item adicionado</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Clique nos produtos para adicionar √† venda</p>
                    </div>
                `;
                totalElement.textContent = formatarMoeda(0);
                return;
            }
            
            container.innerHTML = '';
            let total = 0;
            
            carrinhoCache.forEach(item => {
                const subtotal = item.preco * item.quantidade;
                total += subtotal;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'item-venda';
                itemElement.innerHTML = `
                    <div class="item-info">
                        <div class="item-nome">${item.nome}</div>
                        <div class="item-details">${formatarMoeda(item.preco)} cada</div>
                    </div>
                    <div class="item-actions">
                        <div class="quantidade-controller">
                            <button onclick="alterarQuantidadeCarrinho('${item.id}', -1)" title="Diminuir quantidade">-</button>
                            <span style="min-width: 30px; text-align: center;">${item.quantidade}</span>
                            <button onclick="alterarQuantidadeCarrinho('${item.id}', 1)" title="Aumentar quantidade">+</button>
                        </div>
                        <span style="font-weight: 500; min-width: 80px; text-align: right;">
                            ${formatarMoeda(subtotal)}
                        </span>
                        <button style="background: none; border: none; color: white; cursor: pointer; padding: 5px;" 
                                onclick="removerDoCarrinho('${item.id}')" title="Remover item">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(itemElement);
            });
            
            totalElement.textContent = formatarMoeda(total);
        }

        async function alterarQuantidadeCarrinho(id, mudanca) {
            const item = carrinhoCache.find(item => item.id === id);
            if (!item) return;
            
            // Encontrar produto original para verificar estoque
            const produto = produtosCache.find(p => p.id === id);
            if (produto) {
                const novaQuantidade = item.quantidade + mudanca;
                if (novaQuantidade > produto.estoque) {
                    showToast(`Estoque insuficiente! Restam apenas ${produto.estoque} unidades.`, 'warning');
                    return;
                }
            }
            
            item.quantidade += mudanca;
            
            if (item.quantidade <= 0) {
                carrinhoCache = carrinhoCache.filter(item => item.id !== id);
            }
            
            // Salvar carrinho
            if (window.dbOperations) {
                await window.dbOperations.saveCart(carrinhoCache);
            } else {
                localStorage.setItem('carrinhoCache', JSON.stringify(carrinhoCache));
            }
            
            atualizarCarrinho();
        }

        async function removerDoCarrinho(id) {
            carrinhoCache = carrinhoCache.filter(item => item.id !== id);
            
            // Salvar carrinho
            if (window.dbOperations) {
                await window.dbOperations.saveCart(carrinhoCache);
            } else {
                localStorage.setItem('carrinhoCache', JSON.stringify(carrinhoCache));
            }
            
            atualizarCarrinho();
            showToast('Item removido do carrinho', 'info');
        }

        // Tornar fun√ß√µes globais para os bot√µes
        window.alterarQuantidadeCarrinho = alterarQuantidadeCarrinho;
        window.removerDoCarrinho = removerDoCarrinho;

        async function finalizarVenda() {
            if (carrinhoCache.length === 0) {
                showToast('Adicione itens √† venda antes de finalizar!', 'warning');
                return;
            }
            
            // Calcular total
            const total = carrinhoCache.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            
            // Criar venda
            const venda = {
                id: gerarId(),
                data: new Date().toISOString(),
                dataFormatada: new Date().toLocaleString('pt-BR'),
                itens: [...carrinhoCache],
                total: total,
                formaPagamento: formaPagamento,
                usuario: currentUser.email,
                nomeUsuario: currentUser.displayName || currentUser.email.split('@')[0]
            };
            
            try {
                // Salvar venda
                if (window.dbOperations) {
                    await window.dbOperations.addSale(venda);
                } else {
                    historicoCache.unshift(venda);
                    localStorage.setItem('historicoCache', JSON.stringify(historicoCache));
                }
                
                // Atualizar estoque dos produtos
                const produtosAtualizados = [...produtosCache];
                carrinhoCache.forEach(itemVenda => {
                    const produtoIndex = produtosAtualizados.findIndex(p => p.id === itemVenda.id);
                    if (produtoIndex !== -1) {
                        produtosAtualizados[produtoIndex].estoque -= itemVenda.quantidade;
                        if (produtosAtualizados[produtoIndex].estoque < 0) {
                            produtosAtualizados[produtoIndex].estoque = 0;
                        }
                    }
                });
                
                // Salvar produtos atualizados
                produtosCache = produtosAtualizados;
                localStorage.setItem('produtosCache', JSON.stringify(produtosCache));
                
                // Limpar carrinho
                carrinhoCache = [];
                if (window.dbOperations) {
                    await window.dbOperations.saveCart([]);
                } else {
                    localStorage.setItem('carrinhoCache', '[]');
                }
                
                // Atualizar interfaces
                atualizarCarrinho();
                renderProdutos();
                renderProdutosCadastrados();
                
                if (document.getElementById('historico-tab')?.classList.contains('active')) {
                    renderHistorico();
                }
                
                showToast(`‚úÖ Venda finalizada com sucesso! Total: ${formatarMoeda(total)} (${formaPagamento})`, 'success', 6000);
                
                // Resetar forma de pagamento
                formaPagamento = 'dinheiro';
                document.querySelectorAll('[data-pagamento]').forEach(btn => {
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                });
                const dinheiroBtn = document.querySelector('[data-pagamento="dinheiro"]');
                if (dinheiroBtn) {
                    dinheiroBtn.style.backgroundColor = '#4f46e5';
                    dinheiroBtn.style.color = 'white';
                }
                
            } catch (error) {
                console.error("Erro ao finalizar venda:", error);
                showToast("Erro ao finalizar venda. Tente novamente.", 'error');
            }
        }

        // ===== FUN√á√ïES RESTANTES DO SISTEMA =====
        // (renderHistorico, cadastrarProduto, etc. - mantidas do c√≥digo anterior)
        
        function setupEventListeners() {
            // Busca de produtos
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', renderProdutos);
            }
            
            // Categorias
            const categoriaBtns = document.querySelectorAll('.categoria-btn');
            categoriaBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    categoriaBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderProdutos();
                    
                    // Focar na busca ap√≥s mudar categoria
                    if (searchInput) {
                        searchInput.focus();
                    }
                });
            });
            
            // Bot√µes de pagamento
            document.querySelectorAll('[data-pagamento]').forEach(btn => {
                btn.addEventListener('click', function() {
                    formaPagamento = this.dataset.pagamento;
                    document.querySelectorAll('[data-pagamento]').forEach(b => {
                        b.style.backgroundColor = '';
                        b.style.color = '';
                    });
                    this.style.backgroundColor = '#4f46e5';
                    this.style.color = 'white';
                    
                    showToast(`Forma de pagamento: ${formaPagamento.toUpperCase()}`, 'info', 2000);
                });
            });
            
            // Definir dinheiro como padr√£o
            const dinheiroBtn = document.querySelector('[data-pagamento="dinheiro"]');
            if (dinheiroBtn) {
                dinheiroBtn.style.backgroundColor = '#4f46e5';
                dinheiroBtn.style.color = 'white';
            }
            
            // Finalizar venda
            const finalizarVendaBtn = document.getElementById('finalizarVenda');
            if (finalizarVendaBtn) {
                finalizarVendaBtn.addEventListener('click', finalizarVenda);
            }
            
            // Cancelar venda
            const cancelarVendaBtn = document.getElementById('cancelarVenda');
            if (cancelarVendaBtn) {
                cancelarVendaBtn.addEventListener('click', async () => {
                    if (carrinhoCache.length === 0) {
                        showToast('O carrinho j√° est√° vazio', 'info');
                        return;
                    }
                    
                    if (confirm('Tem certeza que deseja cancelar esta venda?\nTodos os itens ser√£o removidos do carrinho.')) {
                        carrinhoCache = [];
                        if (window.dbOperations) {
                            await window.dbOperations.saveCart([]);
                        } else {
                            localStorage.setItem('carrinhoCache', '[]');
                        }
                        atualizarCarrinho();
                        showToast('Venda cancelada', 'success');
                    }
                });
            }
            
            // Formul√°rio de produto
            const formProduto = document.getElementById('formProduto');
            if (formProduto) {
                formProduto.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const nome = document.getElementById('produtoNome').value.trim();
                    const preco = parseFloat(document.getElementById('produtoPreco').value);
                    const categoria = document.getElementById('produtoCategoria').value;
                    const estoque = parseInt(document.getElementById('produtoEstoque').value);
                    const codigo = document.getElementById('produtoCodigo').value.trim();
                    
                    if (!nome) {
                        showToast('Informe o nome do produto', 'error');
                        return;
                    }
                    
                    if (isNaN(preco) || preco <= 0) {
                        showToast('Informe um pre√ßo v√°lido', 'error');
                        return;
                    }
                    
                    if (!categoria) {
                        showToast('Selecione uma categoria', 'error');
                        return;
                    }
                    
                    if (isNaN(estoque) || estoque < 0) {
                        showToast('Informe um estoque v√°lido', 'error');
                        return;
                    }
                    
                    const novoProduto = {
                        id: gerarId(),
                        nome,
                        preco,
                        categoria,
                        estoque,
                        codigo: codigo || '',
                        imagem: '',
                        createdAt: new Date().toISOString()
                    };
                    
                    try {
                        // Salvar produto
                        if (window.dbOperations) {
                            await window.dbOperations.addProduct(novoProduto);
                        } else {
                            produtosCache.push(novoProduto);
                            localStorage.setItem('produtosCache', JSON.stringify(produtosCache));
                        }
                        
                        // Limpar formul√°rio
                        formProduto.reset();
                        document.getElementById('produtoEstoque').value = '0';
                        document.getElementById('produtoCodigo').value = '';
                        
                        // Atualizar interfaces
                        renderProdutos();
                        renderProdutosCadastrados();
                        
                        showToast(`Produto "${nome}" cadastrado com sucesso!`, 'success');
                        
                        // Focar no campo de nome para pr√≥ximo cadastro
                        document.getElementById('produtoNome').focus();
                        
                    } catch (error) {
                        console.error("Erro ao cadastrar produto:", error);
                        showToast("Erro ao cadastrar produto. Tente novamente.", 'error');
                    }
                });
            }
            
            // Configurar outras funcionalidades (mantidas do c√≥digo anterior)
            setupRemainingEventListeners();
        }
        
        function setupRemainingEventListeners() {
            // Adicionar ao Notepad
            const adicionarNotepadBtn = document.getElementById('adicionarNotepadBtn');
            if (adicionarNotepadBtn) {
                adicionarNotepadBtn.addEventListener('click', () => {
                    const cliente = document.getElementById('notepadCliente').value.trim();
                    const produto = document.getElementById('notepadProduto').value.trim();
                    const quantidade = parseInt(document.getElementById('notepadQuantidade').value);
                    const preco = parseFloat(document.getElementById('notepadPreco').value);
                    
                    if (!cliente) {
                        showToast('Informe o nome do cliente', 'error');
                        document.getElementById('notepadCliente').focus();
                        return;
                    }
                    
                    if (!produto) {
                        showToast('Informe o nome do produto', 'error');
                        document.getElementById('notepadProduto').focus();
                        return;
                    }
                    
                    if (isNaN(quantidade) || quantidade <= 0) {
                        showToast('Informe uma quantidade v√°lida', 'error');
                        document.getElementById('notepadQuantidade').focus();
                        return;
                    }
                    
                    if (isNaN(preco) || preco <= 0) {
                        showToast('Informe um pre√ßo v√°lido', 'error');
                        document.getElementById('notepadPreco').focus();
                        return;
                    }
                    
                    const novoItem = {
                        id: gerarId(),
                        cliente,
                        produto,
                        quantidade,
                        preco,
                        data: new Date().toISOString()
                    };
                    
                    notepadItens.push(novoItem);
                    localStorage.setItem('notepadItens', JSON.stringify(notepadItens));
                    
                    // Renderizar notepad
                    const container = document.getElementById('notepadItens');
                    const totalElement = document.getElementById('notepadTotal');
                    if (container && totalElement) {
                        // Simples renderiza√ß√£o para exemplo
                        container.innerHTML = '';
                        let total = 0;
                        
                        notepadItens.forEach((item, index) => {
                            const subtotal = item.preco * item.quantidade;
                            total += subtotal;
                            
                            const itemElement = document.createElement('div');
                            itemElement.className = 'item-venda';
                            itemElement.style.background = 'white';
                            itemElement.style.border = '1px solid #e2e8f0';
                            itemElement.style.color = '#1e293b';
                            itemElement.style.marginBottom = '0.5rem';
                            
                            itemElement.innerHTML = `
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${item.cliente}</div>
                                    <div style="font-size: 0.875rem; color: #64748b;">
                                        ${item.quantidade}x ${item.produto}
                                    </div>
                                </div>
                                <div style="font-weight: 500;">
                                    ${formatarMoeda(subtotal)}
                                </div>
                                <button style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; margin-left: 10px;"
                                        onclick="removerDoNotepad(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            
                            container.appendChild(itemElement);
                        });
                        
                        totalElement.textContent = formatarMoeda(total);
                    }
                    
                    // Limpar campos (exceto cliente)
                    document.getElementById('notepadProduto').value = '';
                    document.getElementById('notepadQuantidade').value = '1';
                    document.getElementById('notepadPreco').value = '';
                    document.getElementById('notepadProduto').focus();
                    
                    showToast(`Item adicionado para ${cliente}`, 'success');
                });
            }
            
            // Tabs
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const targetTab = document.getElementById(`${tabId}-tab`);
                    if (targetTab) targetTab.classList.add('active');
                    
                    const searchInput = document.getElementById('searchInput');
                    if (tabId === 'pdv' && searchInput) {
                        setTimeout(() => {
                            searchInput.focus();
                            renderProdutos();
                        }, 100);
                    }
                    
                    if (tabId === 'historico') {
                        // Renderizar hist√≥rico
                        const container = document.getElementById('historicoVendas');
                        if (container) {
                            container.innerHTML = '';
                            
                            if (historicoCache.length === 0) {
                                container.innerHTML = `
                                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                                        <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                        <p>Nenhuma venda registrada</p>
                                    </div>
                                `;
                            } else {
                                historicoCache.forEach(venda => {
                                    const vendaElement = document.createElement('div');
                                    vendaElement.className = 'item-venda';
                                    vendaElement.style.background = 'white';
                                    vendaElement.style.border = '1px solid #e2e8f0';
                                    vendaElement.style.color = '#1e293b';
                                    vendaElement.style.marginBottom = '1rem';
                                    vendaElement.style.padding = '1rem';
                                    
                                    vendaElement.innerHTML = `
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                                ${venda.dataFormatada || new Date(venda.data).toLocaleString('pt-BR')}
                                            </div>
                                            <div style="font-size: 0.875rem; color: #64748b;">
                                                ${venda.itens.length} item(s) ‚Ä¢ ${venda.formaPagamento || 'N/D'}
                                            </div>
                                        </div>
                                        <div style="font-weight: 600; font-size: 1.25rem; color: #1a1a1a;">
                                            ${formatarMoeda(venda.total)}
                                        </div>
                                    `;
                                    
                                    container.appendChild(vendaElement);
                                });
                            }
                        }
                    }
                    
                    if (tabId === 'cadastro') {
                        renderProdutosCadastrados();
                        document.getElementById('produtoNome').focus();
                    }
                    
                    if (tabId === 'notepad') {
                        document.getElementById('notepadCliente').focus();
                    }
                });
            });
        }
        
        function renderProdutosCadastrados() {
            const container = document.getElementById('produtosCadastrados');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (produtosCache.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; width: 100%; padding: 2rem; color: #64748b;">
                        <i class="fas fa-boxes" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhum produto cadastrado</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Use o formul√°rio acima para cadastrar produtos</p>
                    </div>
                `;
                return;
            }
            
            produtosCache.forEach(produto => {
                const produtoCard = document.createElement('div');
                produtoCard.className = 'produto-card';
                
                produtoCard.innerHTML = `
                    <img src="${produto.imagem || 'https://images.unsplash.com/photo-1578916171728-46686eac8d58?w=150&h=120&fit=crop'}" alt="${produto.nome}">
                    <div class="produto-estoque ${produto.estoque < 5 ? 'estoque-baixo' : ''}">
                        ${produto.estoque} dispon√≠veis
                    </div>
                    <div class="produto-info">
                        <div class="produto-nome">${produto.nome}</div>
                        <div class="produto-preco">${formatarMoeda(produto.preco)}</div>
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                            ${produto.categoria || 'Sem categoria'}
                        </div>
                        ${produto.codigo ? `<div style="font-size: 0.75rem; color: #64748b;">C√≥d: ${produto.codigo}</div>` : ''}
                        <button style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; background-color: #ef4444; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;"
                                onclick="removerProduto('${produto.id}')" title="Remover produto">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                `;
                
                container.appendChild(produtoCard);
            });
        }
        
        async function removerProduto(id) {
            if (!confirm('Tem certeza que deseja remover este produto?\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                // Remover produto
                if (window.dbOperations) {
                    await window.dbOperations.deleteProduct(id);
                }
                
                // Remover localmente
                produtosCache = produtosCache.filter(produto => produto.id !== id);
                localStorage.setItem('produtosCache', JSON.stringify(produtosCache));
                
                // Remover do carrinho se estiver l√°
                if (carrinhoCache.some(item => item.id === id)) {
                    carrinhoCache = carrinhoCache.filter(item => item.id !== id);
                    if (window.dbOperations) {
                        await window.dbOperations.saveCart(carrinhoCache);
                    } else {
                        localStorage.setItem('carrinhoCache', JSON.stringify(carrinhoCache));
                    }
                    atualizarCarrinho();
                }
                
                renderProdutos();
                renderProdutosCadastrados();
                
                showToast('Produto removido com sucesso', 'success');
            } catch (error) {
                console.error("Erro ao remover produto:", error);
                showToast("Erro ao remover produto", 'error');
            }
        }
        
        window.removerProduto = removerProduto;
        window.removerDoNotepad = (index) => {
            notepadItens.splice(index, 1);
            localStorage.setItem('notepadItens', JSON.stringify(notepadItens));
            showToast('Item removido do Notepad', 'info');
            // Recarregar a aba atual (simplificado)
            if (document.getElementById('notepad-tab').classList.contains('active')) {
                location.reload(); // Recarregar simples para exemplo
            }
        };

        // ===== INICIALIZA√á√ÉO DO SISTEMA =====
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ Sistema PDV Adega carregado");
            
            // Iniciar sistema de autentica√ß√£o
            setupAuth();
            
            // Configurar atalhos de teclado
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                switch(e.key) {
                    case 'F1':
                        e.preventDefault();
                        showToast("üìã Atalhos: F9-Finalizar venda, F10-Cancelar venda", 'info', 5000);
                        break;
                    case 'F9':
                        e.preventDefault();
                        finalizarVenda();
                        break;
                    case 'F10':
                        e.preventDefault();
                        document.getElementById('cancelarVenda')?.click();
                        break;
                }
            });
        });

        // ===== FUN√á√ïES DE DEBUG =====
        
        window.debugSystem = () => {
            const status = {
                usuario: currentUser ? currentUser.email : 'N√£o logado',
                produtos: produtosCache.length,
                carrinho: carrinhoCache.length,
                historico: historicoCache.length,
                notepad: notepadItens.length,
                firebase: window.firebaseReady ? '‚úÖ Conectado' : '‚ùå N√£o conectado',
                modo: currentUser && currentUser.email === 'teste@adega.com' ? 'TESTE' : 'PRODU√á√ÉO'
            };
            
            console.log("üîß Debug do Sistema:", status);
            showToast(`Sistema: ${status.usuario} | Produtos: ${status.produtos} | Modo: ${status.modo}`, 'info', 5000);
            
            return status;
        };
        
        // Expor fun√ß√£o de debug globalmente
        window.debugPDV = window.debugSystem;
    </script>
</body>
</html>
